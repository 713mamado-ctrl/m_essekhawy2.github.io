<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>أضف رأيك</title>
<style>
  body{font-family:Arial, sans-serif;direction:rtl;background:#f3f6fa;padding:20px;margin:0}
  h1{text-align:center;color:#1E3A8A}
  #reviewsContainer{max-width:700px;margin:0 auto 20px}
  .review{background:#fff;border-radius:10px;padding:14px 18px;margin-bottom:12px;box-shadow:0 3px 8px rgba(0,0,0,0.06);position:relative}
  .review p{margin:6px 0;color:#222}
  .review strong{color:#1E3A8A}
  .buttons{position:absolute;top:10px;left:10px;display:flex;gap:8px}
  .btn{background:#efefef;border:none;padding:6px 8px;border-radius:6px;cursor:pointer}
  form{max-width:700px;margin:0 auto;background:#fff;padding:18px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,0.04);display:flex;flex-direction:column;gap:10px}
  input,textarea{padding:10px;border-radius:8px;border:1px solid #ccc;font-size:15px;width:100%;box-sizing:border-box}
  textarea{min-height:90px;resize:vertical}
  button[type=submit]{background:#1E3A8A;color:#fff;border:none;padding:12px;border-radius:8px;cursor:pointer}
  #formMessage{text-align:center;color:green;font-size:14px}
</style>
</head>
<body>

<h1>أضف رأيك</h1>

<!-- الآراء تظهر هنا فوق الفورم -->
<div id="reviewsContainer" aria-live="polite"></div>

<form id="reviewForm">
  <input id="name" type="text" placeholder="اكتب اسمك" required />
  <input id="email" type="email" placeholder="البريد الإلكتروني" required />
  <textarea id="comment" placeholder="اكتب تعليقك هنا" required></textarea>
  <button type="submit">إرسال</button>
  <div id="formMessage" role="status"></div>
</form>

<!-- Firebase compat scripts -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ====== ضع هنا إعدادات Firebase الخاصة بك ====== */
const firebaseConfig = {
  apiKey: "PUT_YOUR_apiKey",
  authDomain: "PUT_YOUR_authDomain",
  databaseURL: "PUT_YOUR_databaseURL",
  projectId: "PUT_YOUR_projectId",
  storageBucket: "PUT_YOUR_storageBucket",
  messagingSenderId: "PUT_YOUR_messagingSenderId",
  appId: "PUT_YOUR_appId"
};
/* =============================================== */

firebase.initializeApp(firebaseConfig);
const dbRef = firebase.database().ref('reviews');

const reviewsContainer = document.getElementById('reviewsContainer');
const form = document.getElementById('reviewForm');
const formMessage = document.getElementById('formMessage');

function makeReviewElement(id, name, comment){
  const div = document.createElement('div');
  div.className = 'review';
  div.setAttribute('data-id', id);

  const nameP = document.createElement('p');
  nameP.innerHTML = `<strong>${escapeHtml(name)}</strong>`;

  const commentP = document.createElement('p');
  commentP.textContent = comment;

  // أزرار تعديل وحذف
  const btnDiv = document.createElement('div');
  btnDiv.className = 'buttons';

  const editBtn = document.createElement('button');
  editBtn.className = 'btn';
  editBtn.textContent = '✏️ تعديل';
  editBtn.onclick = () => editComment(id);

  const delBtn = document.createElement('button');
  delBtn.className = 'btn';
  delBtn.textContent = '🗑️ حذف';
  delBtn.onclick = () => deleteComment(id);

  btnDiv.appendChild(editBtn);
  btnDiv.appendChild(delBtn);

  div.appendChild(nameP);
  div.appendChild(commentP);
  div.appendChild(btnDiv);

  return div;
}

/* عرض التعليق فورًا (يعرض فوق كل التعليقات) */
function displayReview(id, name, comment){
  // إذا العنصر موجود مسبقاً نحدّثه؛ وإلا نُنشئه
  const existing = document.querySelector(`.review[data-id="${id}"]`);
  if(existing) existing.remove();
  const el = makeReviewElement(id, name, comment);
  reviewsContainer.prepend(el); // الأحدث فوق
}

/* تحميل كل التعليقات عند البدء */
function loadAllReviews(){
  reviewsContainer.innerHTML = ''; // تنظف قبل التحميل لتفادى التكرار
  dbRef.once('value', snap => {
    const data = snap.val();
    if(!data) return;
    // نُظهر الأحدث أولًا (المفتاح لا يحوي تاريخ، لذلك نُرتّب حسب ترقيم الإدخالات زمنياً عبر الترتيب الافتراضي)
    const entries = Object.entries(data);
    // لو عايز ترتيب بعكس: entries.reverse()
    entries.reverse().forEach(([key, value])=>{
      displayReview(key, value.name || 'مجهول', value.comment || '');
    });
  }, err => console.error('DB load error', err));
}

/* استماع لتحديثات فورية (اضافة\تعديل\حذف) */
dbRef.on('child_added', snap => {
  const v = snap.val();
  // لو العنصر موجود بالفعل (عرضنا فوراً على submit) نتجنّب الازدواج:
  if(document.querySelector(`.review[data-id="${snap.key}"]`)) return;
  displayReview(snap.key, v.name, v.comment);
});
dbRef.on('child_changed', snap => {
  const v = snap.val();
  displayReview(snap.key, v.name, v.comment);
});
dbRef.on('child_removed', snap => {
  const el = document.querySelector(`.review[data-id="${snap.key}"]`);
  if(el) el.remove();
});

/* إرسال فوراً + حفظ في Firebase */
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  formMessage.textContent = '';
  const name = document.getElementById('name').value.trim();
  const email = document.getElementById('email').value.trim(); // نحتفظ بالايميل في DB
  const comment = document.getElementById('comment').value.trim();
  if(!name || !email || !comment) { formMessage.textContent = 'املأ كل الحقول.'; return; }

  // تحقق سريع من الايميل
  const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if(!emailPattern.test(email)){ formMessage.textContent = 'بريد إلكتروني غير صحيح.'; return; }

  try {
    // عرض فوري للمستخدم قبل انتظار DB
    const tempRef = dbRef.push(); // نحصل على مفتاح
    displayReview(tempRef.key, name, comment);
    // نحفظ الايميل والاسم والتعليق في DB
    await tempRef.set({ name, email, comment, createdAt: Date.now() });
    form.reset();
    formMessage.textContent = 'تم إرسال رأيك بنجاح!';
  } catch (err) {
    console.error('Save error', err);
    formMessage.textContent = 'حدث خطأ أثناء الإرسال. افتح الكونسول لتفاصيل الخطأ.';
  }
});

/* حذف وتعديل */
function deleteComment(id){
  if(confirm('هل تريد حذف هذا الرأي؟')) dbRef.child(id).remove();
}
function editComment(id){
  const el = document.querySelector(`.review[data-id="${id}"]`);
  if(!el) return alert('العنصر غير موجود.');
  const old = el.querySelectorAll('p')[1].textContent;
  const updated = prompt('عدل تعليقك:', old);
  if(updated === null) return; // الغاء
  const trimmed = updated.trim();
  if(trimmed === '') return alert('التعليق لا يمكن أن يكون فارغاً.');
  dbRef.child(id).update({ comment: trimmed, editedAt: Date.now() });
}

/* مساعدة للـ XSS: تهريب النصوص */
function escapeHtml(str){
  return String(str).replace(/[&<>"'`=\/]/g, s => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'
  })[s]);
}

/* تحميل بداية */
document.addEventListener('DOMContentLoaded', () => {
  loadAllReviews();
});
</script>
</body>
</html>
