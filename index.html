<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø£Ø¶Ù Ø±Ø£ÙŠÙƒ</title>
<style>
  body{font-family:Arial, sans-serif;direction:rtl;background:#f3f6fa;padding:20px;margin:0}
  h1{text-align:center;color:#1E3A8A}
  #reviewsContainer{max-width:700px;margin:0 auto 20px}
  .review{background:#fff;border-radius:10px;padding:14px 18px;margin-bottom:12px;box-shadow:0 3px 8px rgba(0,0,0,0.06);position:relative}
  .review p{margin:6px 0;color:#222}
  .review strong{color:#1E3A8A}
  .buttons{position:absolute;top:10px;left:10px;display:flex;gap:8px}
  .btn{background:#efefef;border:none;padding:6px 8px;border-radius:6px;cursor:pointer}
  form{max-width:700px;margin:0 auto;background:#fff;padding:18px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,0.04);display:flex;flex-direction:column;gap:10px}
  input,textarea{padding:10px;border-radius:8px;border:1px solid #ccc;font-size:15px;width:100%;box-sizing:border-box}
  textarea{min-height:90px;resize:vertical}
  button[type=submit]{background:#1E3A8A;color:#fff;border:none;padding:12px;border-radius:8px;cursor:pointer}
  #formMessage{text-align:center;color:green;font-size:14px}
</style>
</head>
<body>

<h1>Ø£Ø¶Ù Ø±Ø£ÙŠÙƒ</h1>

<!-- Ø§Ù„Ø¢Ø±Ø§Ø¡ ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ ÙÙˆÙ‚ Ø§Ù„ÙÙˆØ±Ù… -->
<div id="reviewsContainer" aria-live="polite"></div>

<form id="reviewForm">
  <input id="name" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ" required />
  <input id="email" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required />
  <textarea id="comment" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ Ù‡Ù†Ø§" required></textarea>
  <button type="submit">Ø¥Ø±Ø³Ø§Ù„</button>
  <div id="formMessage" role="status"></div>
</form>

<!-- Firebase compat scripts -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ====== Ø¶Ø¹ Ù‡Ù†Ø§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ ====== */
const firebaseConfig = {
  apiKey: "PUT_YOUR_apiKey",
  authDomain: "PUT_YOUR_authDomain",
  databaseURL: "PUT_YOUR_databaseURL",
  projectId: "PUT_YOUR_projectId",
  storageBucket: "PUT_YOUR_storageBucket",
  messagingSenderId: "PUT_YOUR_messagingSenderId",
  appId: "PUT_YOUR_appId"
};
/* =============================================== */

firebase.initializeApp(firebaseConfig);
const dbRef = firebase.database().ref('reviews');

const reviewsContainer = document.getElementById('reviewsContainer');
const form = document.getElementById('reviewForm');
const formMessage = document.getElementById('formMessage');

function makeReviewElement(id, name, comment){
  const div = document.createElement('div');
  div.className = 'review';
  div.setAttribute('data-id', id);

  const nameP = document.createElement('p');
  nameP.innerHTML = `<strong>${escapeHtml(name)}</strong>`;

  const commentP = document.createElement('p');
  commentP.textContent = comment;

  // Ø£Ø²Ø±Ø§Ø± ØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø°Ù
  const btnDiv = document.createElement('div');
  btnDiv.className = 'buttons';

  const editBtn = document.createElement('button');
  editBtn.className = 'btn';
  editBtn.textContent = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„';
  editBtn.onclick = () => editComment(id);

  const delBtn = document.createElement('button');
  delBtn.className = 'btn';
  delBtn.textContent = 'ğŸ—‘ï¸ Ø­Ø°Ù';
  delBtn.onclick = () => deleteComment(id);

  btnDiv.appendChild(editBtn);
  btnDiv.appendChild(delBtn);

  div.appendChild(nameP);
  div.appendChild(commentP);
  div.appendChild(btnDiv);

  return div;
}

/* Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ ÙÙˆØ±Ù‹Ø§ (ÙŠØ¹Ø±Ø¶ ÙÙˆÙ‚ ÙƒÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª) */
function displayReview(id, name, comment){
  // Ø¥Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù†Ø­Ø¯Ù‘Ø«Ù‡Ø› ÙˆØ¥Ù„Ø§ Ù†ÙÙ†Ø´Ø¦Ù‡
  const existing = document.querySelector(`.review[data-id="${id}"]`);
  if(existing) existing.remove();
  const el = makeReviewElement(id, name, comment);
  reviewsContainer.prepend(el); // Ø§Ù„Ø£Ø­Ø¯Ø« ÙÙˆÙ‚
}

/* ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡ */
function loadAllReviews(){
  reviewsContainer.innerHTML = ''; // ØªÙ†Ø¸Ù Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„ØªÙØ§Ø¯Ù‰ Ø§Ù„ØªÙƒØ±Ø§Ø±
  dbRef.once('value', snap => {
    const data = snap.val();
    if(!data) return;
    // Ù†ÙØ¸Ù‡Ø± Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ù‹Ø§ (Ø§Ù„Ù…ÙØªØ§Ø­ Ù„Ø§ ÙŠØ­ÙˆÙŠ ØªØ§Ø±ÙŠØ®ØŒ Ù„Ø°Ù„Ùƒ Ù†ÙØ±ØªÙ‘Ø¨ Ø­Ø³Ø¨ ØªØ±Ù‚ÙŠÙ… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª Ø²Ù…Ù†ÙŠØ§Ù‹ Ø¹Ø¨Ø± Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ)
    const entries = Object.entries(data);
    // Ù„Ùˆ Ø¹Ø§ÙŠØ² ØªØ±ØªÙŠØ¨ Ø¨Ø¹ÙƒØ³: entries.reverse()
    entries.reverse().forEach(([key, value])=>{
      displayReview(key, value.name || 'Ù…Ø¬Ù‡ÙˆÙ„', value.comment || '');
    });
  }, err => console.error('DB load error', err));
}

/* Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙˆØ±ÙŠØ© (Ø§Ø¶Ø§ÙØ©\ØªØ¹Ø¯ÙŠÙ„\Ø­Ø°Ù) */
dbRef.on('child_added', snap => {
  const v = snap.val();
  // Ù„Ùˆ Ø§Ù„Ø¹Ù†ØµØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ (Ø¹Ø±Ø¶Ù†Ø§ ÙÙˆØ±Ø§Ù‹ Ø¹Ù„Ù‰ submit) Ù†ØªØ¬Ù†Ù‘Ø¨ Ø§Ù„Ø§Ø²Ø¯ÙˆØ§Ø¬:
  if(document.querySelector(`.review[data-id="${snap.key}"]`)) return;
  displayReview(snap.key, v.name, v.comment);
});
dbRef.on('child_changed', snap => {
  const v = snap.val();
  displayReview(snap.key, v.name, v.comment);
});
dbRef.on('child_removed', snap => {
  const el = document.querySelector(`.review[data-id="${snap.key}"]`);
  if(el) el.remove();
});

/* Ø¥Ø±Ø³Ø§Ù„ ÙÙˆØ±Ø§Ù‹ + Ø­ÙØ¸ ÙÙŠ Firebase */
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  formMessage.textContent = '';
  const name = document.getElementById('name').value.trim();
  const email = document.getElementById('email').value.trim(); // Ù†Ø­ØªÙØ¸ Ø¨Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„ ÙÙŠ DB
  const comment = document.getElementById('comment').value.trim();
  if(!name || !email || !comment) { formMessage.textContent = 'Ø§Ù…Ù„Ø£ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„.'; return; }

  // ØªØ­Ù‚Ù‚ Ø³Ø±ÙŠØ¹ Ù…Ù† Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„
  const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if(!emailPattern.test(email)){ formMessage.textContent = 'Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­.'; return; }

  try {
    // Ø¹Ø±Ø¶ ÙÙˆØ±ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¨Ù„ Ø§Ù†ØªØ¸Ø§Ø± DB
    const tempRef = dbRef.push(); // Ù†Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­
    displayReview(tempRef.key, name, comment);
    // Ù†Ø­ÙØ¸ Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„ ÙˆØ§Ù„Ø§Ø³Ù… ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚ ÙÙŠ DB
    await tempRef.set({ name, email, comment, createdAt: Date.now() });
    form.reset();
    formMessage.textContent = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø£ÙŠÙƒ Ø¨Ù†Ø¬Ø§Ø­!';
  } catch (err) {
    console.error('Save error', err);
    formMessage.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. Ø§ÙØªØ­ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£.';
  }
});

/* Ø­Ø°Ù ÙˆØªØ¹Ø¯ÙŠÙ„ */
function deleteComment(id){
  if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø±Ø£ÙŠØŸ')) dbRef.child(id).remove();
}
function editComment(id){
  const el = document.querySelector(`.review[data-id="${id}"]`);
  if(!el) return alert('Ø§Ù„Ø¹Ù†ØµØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.');
  const old = el.querySelectorAll('p')[1].textContent;
  const updated = prompt('Ø¹Ø¯Ù„ ØªØ¹Ù„ÙŠÙ‚Ùƒ:', old);
  if(updated === null) return; // Ø§Ù„ØºØ§Ø¡
  const trimmed = updated.trim();
  if(trimmed === '') return alert('Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºØ§Ù‹.');
  dbRef.child(id).update({ comment: trimmed, editedAt: Date.now() });
}

/* Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ù€ XSS: ØªÙ‡Ø±ÙŠØ¨ Ø§Ù„Ù†ØµÙˆØµ */
function escapeHtml(str){
  return String(str).replace(/[&<>"'`=\/]/g, s => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'
  })[s]);
}

/* ØªØ­Ù…ÙŠÙ„ Ø¨Ø¯Ø§ÙŠØ© */
document.addEventListener('DOMContentLoaded', () => {
  loadAllReviews();
});
</script>
</body>
</html>
